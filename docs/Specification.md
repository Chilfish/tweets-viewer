# Frontend Functional Specification: Tweets Viewer

> **文档性质**：本文档是 Tweets Viewer 前端系统的**功能规格说明书 (Functional Spec)** 。它定义了系统的逻辑行为、数据流转规则和用户交互标准，与具体的技术选型无关。

## 1. 系统定义 (System Definition)

**Tweets Viewer** 是一个**归档导向**的推特内容浏览终端。它不直接连接 Twitter 实时流，而是作为一个**静态数据的动态阅读器**。

### 核心原则

1. **只读性 (Read-Only)** : 系统不提供任何写入（发推、点赞、关注）功能。
2. **流动性 (Fluidity)** : 尽管数据是静态归档，但浏览体验必须是连续的、无缝的流式体验。
3. **用户隔离 (User-Isolated)** : 系统的上下文始终被限定在“当前选定的归档用户”范围内。

---

## 2. 领域模型 (Domain Models)

本节定义系统核心的逻辑实体及其属性，这些实体构成了前端的状态基础。

### 2.1 用户上下文 (User Context)

系统必须维护一份**已归档用户列表**和**当前活跃用户**。

- **行为规格**：
  - **自动同步**: 当路由参数变化时，系统需自动切换“当前活跃用户”。
  - **上下文重置**: 切换用户是一次“硬重置”操作，必须清除所有先前用户的推文数据、页码状态和临时过滤器，防止数据串扰。
  - **元数据缓存**: 用户的基础信息（头像、ID、简介）应在客户端持久化，以支持离线访问和秒级切换。

### 2.2 推文流 (Tweet Stream)

推文流是系统的主体内容实体。

- **属性**:
  - `FullText`: 推文正文。
  - `Media`: 图片/视频附件集合。
  - `Metrics`: 转推/点赞/引用数。
  - `Context`: 是否为回复、引用或转推。

- **逻辑状态**:
  - `Idle`: 初始状态。
  - `Fetching`:正在请求数据。
  - `Ready`: 数据已加载且可渲染。
  - `Exhausted`: 已无更多数据（End of List）。
  - `Error`: 数据获取失败。

### 2.3 过滤器 (Filters)

过滤器是决定推文流内容的参数集合。

- **定义**:
  - `SortOrder`: 排序方向（最新优先/最旧优先）。
  - `DateRange`: 起始日期与结束日期。
  - `Keyword`: 全文搜索关键字。

- **行为规格**:
  - **互斥性**: 过滤器的任何变更（Change Event）都必须触发推文流的**完全重载 (Hard Reload)** 。不允许在现有列表上进行客户端过滤（必须重新向后端请求）。

### 2.4 媒体画廊 (Media Gallery)

从推文流中衍生出的纯媒体视图。

- **提取规则**: 仅提取包含 `NativeMedia` (图片/视频) 的推文，忽略纯文本推文。
- **聚合策略**: 为了填充网格视图，系统必须支持**激进预加载 (Aggressive Preloading)** —— 即自动连续请求多页推文数据，直到累积了足够数量的媒体项或数据耗尽。

---

## 3. 路由与视图拓扑 (Routing & View Topology)

系统采用**以用户为中心**的路由策略。URL 是视图状态的唯一真值来源 (Source of Truth)。

### 3.1 URL 结构规范

所有视图路径均包含 `:userId` 作为核心锚点。

| 逻辑视图     | URL 模式          | 职责描述                               |
| :----------- | :---------------- | :------------------------------------- |
| **主时间线** | `/tweets/:userId` | 展示全量推文流，支持标准过滤。         |
| **媒体墙**   | `/media/:userId`  | 仅展示图片/视频网格，点击查看详情。    |
| **那年今日** | `/memo/:userId`   | 展示历史上的今天发布的推文（跨年份）。 |
| **搜索视图** | `/search/:userId` | 基于关键词的搜索结果流。               |

### 3.2 状态同步协议 (State Sync Protocol)

前端状态必须与 URL 查询参数 (Query Params) 保持双向强一致性。

1. **初始化 (Hydration)** : 应用启动时，必须解析 URL 参数 ( `page`, `sort`, `start`, `end`) 并注入到过滤器模型中。
2. **序列化 (Serialization)** : 用户在 UI 上修改过滤器后，系统必须先更新 URL，再通过监听 URL 变化来触发数据加载。
   - _例外_: 无限滚动的页码变化不需要实时写入 URL 历史栈（避免污染浏览器后退功能），可以作为临时状态处理。

---

## 4. 功能行为规格 (Functional Behaviors)

### 4.1 无限分页机制 (The Infinite Pagination)

系统必须实现标准的游标分页或偏移量分页行为。

- **触发条件**: 当视口 (Viewport) 底部距离列表底部小于特定阈值（推荐 1.5 屏高度）时。

- **守卫条件**:
  - 若 `Status` 为 `Fetching`，忽略触发。
  - 若 `Status` 为 `Exhausted`，忽略触发。
  - 若 `Status` 为 `Error`，忽略触发（需用户手动重试）。

- **数据合并**: 新加载的数据块必须**追加 (Append)** 到现有列表尾部，严禁替换现有数据。

### 4.2 智能媒体聚合 (Smart Media Accumulation)

针对媒体墙视图的特殊加载逻辑：

- **问题**: 普通分页可能连续 5 页都是纯文本推文，导致媒体墙空白。
- **逻辑**:

```
过程 加载媒体页(当前页码):
发起请求(当前页码)
提取媒体项 -> 存入临时池
如果 (临时池数量 < 最小展示阈值) 且 (仍有更多数据):
递归调用 加载媒体页(下一页码)
否则:
渲染临时池
更新当前页码状态
```

### 4.3 实体引用处理 (Entity References)

- **引用推文 (Quoted Status)** : 必须作为**嵌套实体**渲染在父推文内部。点击引用部分应导航至该原始推文（如果存在于归档中）或外部链接。
- **媒体附件**: 支持多图网格布局。点击任意媒体应进入**沉浸式浏览模式 (Lightbox)** 。

---

## 5. UI 系统规格 (UI System Specs)

### 5.1 布局响应策略

系统定义两种互斥的布局模式：

- **桌面模式 (Desktop Mode)** :
  - **结构**: `Sidebar (Left, Fixed)` + `Main Content (Center, Scroll)`。
  - **导航**: 通过 Sidebar 切换用户和视图。

- **移动模式 (Mobile Mode)** :
  - **结构**: `TopNav (Header, Sticky)` + `Main Content (Body, Scroll)` + `BottomNav (Footer, Fixed)`。
  - **导航**: TopNav 显示当前用户，BottomNav 切换视图类型。

### 5.2 交互反馈标准

- **加载中**: 必须展示骨架屏 (Skeleton) 或微交互加载器 (Spinner)，禁止展示空白屏幕。
- **空状态**: 当列表长度为 0 且状态为 `Ready` 时，必须展示具体的空状态提示（如“没有找到相关推文”），区分“加载中”和“无数据”。
- **滚动恢复**: 从详情页返回列表页时，必须精确定位到之前的滚动位置。

## 6. 非功能性需求 (Non-Functional Requirements)

1. **归档不可变性**: 前端严禁修改后端返回的推文内容（除了本地格式化日期或数字）。
2. **图像懒加载**: 视口外的媒体资源严禁预加载，必须使用 Lazy Loading 机制节省带宽。
3. **错误恢复**: 网络请求失败时，必须提供“点击重试”机制，而不能导致整个应用崩溃。
